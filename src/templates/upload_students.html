<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Students - S3 Management</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background: #f0f2f5;
        }

        .container {
            max-width: 900px;
            margin: 50px auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            padding: 30px;
            color: white;
        }

        .header h1 {
            margin: 0;
            font-size: 24px;
        }

        .header p {
            margin: 10px 0 0;
            opacity: 0.8;
        }

        .nav-tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            background: #fff;
        }

        .nav-tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            color: #7f8c8d;
            transition: all 0.3s;
        }

        .nav-tab:hover {
            background: #f8f9fa;
            color: #2c3e50;
        }

        .nav-tab.active {
            border-bottom: 3px solid #3498db;
            color: #3498db;
        }

        .content {
            padding: 40px;
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
            animation: fadeIn 0.5s;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #34495e;
        }

        input[type="text"],
        input[type="file"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-sizing: border-box;
        }

        .helper-text {
            font-size: 13px;
            color: #7f8c8d;
            margin-top: 5px;
        }

        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.2s;
        }

        button:hover {
            background: #2980b9;
        }

        button:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }

        .status-box {
            margin-top: 25px;
            padding: 15px;
            border-radius: 6px;
            display: none;
        }

        .status-box.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-box.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .error-list {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
            font-size: 14px;
            border: 1px solid #f5c6cb;
            padding: 10px;
            background: white;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .nav-back {
            display: inline-block;
            margin-bottom: 10px;
            color: white;
            text-decoration: none;
            font-size: 14px;
            opacity: 0.9;
        }

        .nav-back {
            display: inline-block;
            margin-bottom: 10px;
            color: white;
            text-decoration: none;
            font-size: 14px;
            opacity: 0.9;
        }

        .nav-back:hover {
            text-decoration: underline;
            opacity: 1;
        }

        .top-nav {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            justify-content: flex-start;
        }

        .top-nav a {
            color: white;
            text-decoration: none;
            font-weight: 600;
            font-size: 14px;
            opacity: 0.8;
            padding: 5px 10px;
            border-radius: 4px;
            border: 1px solid transparent;
        }

        .top-nav a:hover {
            opacity: 1;
            background: rgba(255, 255, 255, 0.1);
        }

        .top-nav a.active {
            background: white;
            color: #2c3e50;
            opacity: 1;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <div class="top-nav">
                {% from 'components/navbar_links.html' import render_common_navbar_links %}
                {{ render_common_navbar_links('/upload-students') }}
            </div>
            <h1>Student Data Upload</h1>
            <p>Upload student images for facial recognition training.</p>
        </div>

        <div class="nav-tabs">
            <div class="nav-tab active" onclick="switchTab('single')">Single Student Upload</div>
            <div class="nav-tab" onclick="switchTab('bulk')">Bulk Upload (Excel)</div>
        </div>

        <div class="content">
            <!-- SINGLE UPLOAD -->
            <div id="tab-single" class="tab-pane active">
                <div class="form-group">
                    <label>Student ID</label>
                    <input type="text" id="singleId" placeholder="e.g. 2024001" />
                    <div class="helper-text">This will be the unique identifier for attendance.</div>
                </div>

                <div class="form-group">
                    <label>Student Name</label>
                    <input type="text" id="singleName" placeholder="e.g. John Doe" />
                </div>

                <div class="form-group">
                    <label>Batch</label>
                    <input type="text" id="singleBatch" placeholder="e.g. JFS-VIJ-01,PFS-HYD-01" />
                    <div class="helper-text">Target Batch (Table Name).</div>
                </div>

                <div class="form-group">
                    <label>Branch</label>
                    <input type="text" id="singleBranch"
                        placeholder="e.g. Vijayawada Main Branch, Hyderabad Main Branch, Vizag Main Branch" />
                </div>

                <div class="form-group">
                    <label>Designation</label>
                    <input type="text" id="singleDesignation"
                        placeholder="e.g.Java Full Stack Trainee, Python Full Stack Trainee, etc." />
                </div>

                <div class="form-group">
                    <label>Gender</label>
                    <select id="singleGender" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box;">
                        <option value="" disabled selected>Select Gender</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                        <option value="Other">Other</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Student Photo</label>
                    <input type="file" id="singleFile" accept="image/*" />
                </div>

                <button onclick="uploadSingle()" id="btnSingle">Upload to S3 & DB</button>
                <div id="statusSingle" class="status-box"></div>
            </div>

            <!-- BULK UPLOAD -->
            <div id="tab-bulk" class="tab-pane">
                <div class="form-group">
                    <label>1. Upload Excel File (Metadata)</label>
                    <input type="file" id="bulkExcel" accept=".xlsx, .xls" />
                    <div class="helper-text">Excel must have columns: <strong>STUDENT ID</strong>,
                        <strong>PHOTO</strong>, <strong>BRANCH</strong>, <strong>DESIGNATION</strong>,
                        <strong>GENDER</strong>.
                    </div>
                </div>

                <div class="form-group">
                    <label>2. Upload Images Folder</label>
                    <input type="file" id="bulkImages" webkitdirectory directory multiple />
                    <div class="helper-text">Select the folder containing the student images. Filenames must match the
                        'PHOTO' column in Excel.</div>
                </div>

                <button onclick="uploadBulk()" id="btnBulk">Start Bulk Upload</button>
                <div id="statusBulk" class="status-box"></div>
            </div>
        </div>
    </div>

    <script>
        function switchTab(tab) {
            document.querySelectorAll('.nav-tab').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-pane').forEach(el => el.classList.remove('active'));

            if (tab === 'single') {
                document.querySelector('.nav-tab:first-child').classList.add('active');
                document.getElementById('tab-single').classList.add('active');
            } else {
                document.querySelector('.nav-tab:last-child').classList.add('active');
                document.getElementById('tab-bulk').classList.add('active');
            }
        }

        async function uploadSingle() {
            const id = document.getElementById('singleId').value.trim();
            const name = document.getElementById('singleName').value.trim();
            const batch = document.getElementById('singleBatch').value.trim();
            const branch = document.getElementById('singleBranch').value.trim();
            const designation = document.getElementById('singleDesignation').value.trim();
            const gender = document.getElementById('singleGender').value;
            const file = document.getElementById('singleFile').files[0];
            const btn = document.getElementById('btnSingle');
            const status = document.getElementById('statusSingle');

            if (!id || !file || !name || !batch) {
                showStatus(status, 'Please fill all required fields (ID, Name, Batch, File).', 'error');
                return;
            }

            setLoading(btn, true);
            showStatus(status, 'Uploading...', 'success'); // using success style for info

            const formData = new FormData();
            formData.append('student_id', id);
            formData.append('student_name', name);
            formData.append('batch', batch);
            formData.append('branch', branch);
            formData.append('designation', designation);
            formData.append('gender', gender);
            formData.append('image', file);

            try {
                const res = await fetch('/api/upload-students/single', { method: 'POST', body: formData });
                const data = await res.json();

                if (data.success) {
                    showStatus(status, data.message, 'success');
                    document.getElementById('singleId').value = '';
                    document.getElementById('singleName').value = '';
                    document.getElementById('singleBatch').value = '';
                    document.getElementById('singleFile').value = '';
                } else {
                    showStatus(status, data.message, 'error');
                }
            } catch (err) {
                showStatus(status, 'Network Error: ' + err.message, 'error');
            } finally {
                setLoading(btn, false);
            }
        }

        async function uploadBulk() {
            const excel = document.getElementById('bulkExcel').files[0];
            const images = document.getElementById('bulkImages').files;
            const btn = document.getElementById('btnBulk');
            const status = document.getElementById('statusBulk');

            if (!excel || images.length === 0) {
                showStatus(status, 'Please select both Excel file and Images Folder.', 'error');
                return;
            }

            setLoading(btn, true);
            showStatus(status, 'Processing Bulk Upload... (This may take time)', 'success');

            const formData = new FormData();
            formData.append('excel', excel);

            for (let i = 0; i < images.length; i++) {
                formData.append('images', images[i]);
            }

            try {
                const res = await fetch('/api/upload-students/bulk', { method: 'POST', body: formData });
                const data = await res.json();
                console.log('Bulk Upload Response:', data); // Debugging

                if (data.success) {
                    // Handle nested data structure from success_response wrapper
                    // Structure: { success: true, data: { uploaded: N, ... } }
                    const innerData = data.data || {};
                    const uploadedCount = innerData.uploaded !== undefined ? innerData.uploaded : (data.uploaded !== undefined ? data.uploaded : 0);
                    const totalCount = innerData.total_expected !== undefined ? innerData.total_expected : (data.total_expected !== undefined ? data.total_expected : 0);
                    const errorsList = innerData.errors || data.errors || [];

                    let msg = `Bulk Operation Finished! Uploaded: ${uploadedCount}/${totalCount}.`;
                    if (errorsList.length > 0) {
                        msg += '<div class="error-list"><strong>Errors:</strong><br>' + errorsList.join('<br>') + '</div>';
                    }
                    showStatus(status, msg, uploadedCount > 0 ? 'success' : 'error');
                } else {
                    showStatus(status, data.message || 'Unknown Error', 'error');
                }
            } catch (err) {
                console.error(err);
                showStatus(status, 'Network Error: ' + err.message, 'error');
            } finally {
                setLoading(btn, false);
            }
        }

        function showStatus(el, msg, type) {
            el.innerHTML = msg;
            el.className = 'status-box ' + type;
            el.style.display = 'block';
        }

        function setLoading(btn, isLoading) {
            btn.disabled = isLoading;
            btn.innerText = isLoading ? 'Processing...' : (btn.id === 'btnSingle' ? 'Upload to S3 & DB' : 'Start Bulk Upload');
        }
    </script>
</body>

</html>